<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Eckey - Libdogecoin, a clean C library of Dogecoin building blocks</title>


        <!-- Custom HTML head -->

        <meta name="description" content="Libdogecoin will be a complete implementation of the Dogecoin Protocols, as a C library (and series of bindings to popular languages) which will allow anyone to build a Dogecoin compliant product, without needing to worry about the deeper, complicated specifics of the crypto functions.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Libdogecoin, a clean C library of Dogecoin building blocks</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/dogecoinfoundation/libdogecoin/tree/main/" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/dogeorg/libdogecoin-docs/edit/main/src/eckey.md" title="Suggest an edit" aria-label="Suggest an edit" rel="edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="libdogecoin-elliptic-curve-key-api"><a class="header" href="#libdogecoin-elliptic-curve-key-api">Libdogecoin Elliptic Curve Key API</a></h1>
<h2 id="table-of-contents"><a class="header" href="#table-of-contents">Table of Contents</a></h2>
<ul>
<li><a href="#libdogecoin-elliptic-curve-key-api">Libdogecoin Elliptic Curve Key API</a>
<ul>
<li><a href="#table-of-contents">Table of Contents</a></li>
<li><a href="#abstract">Abstract</a></li>
<li><a href="#specification">Specification</a></li>
<li><a href="#primitives">Primitives</a></li>
<li><a href="#basic-elliptic-curve-key-api">Basic Elliptic Curve Key API</a>
<ul>
<li><a href="#eckey"><strong>eckey:</strong></a></li>
<li><a href="#keys"><strong>keys:</strong></a></li>
<li><a href="#new_eckey"><strong>new_eckey:</strong></a></li>
<li><a href="#new_eckey_from_privkey"><strong>new_eckey_from_privkey:</strong></a></li>
<li><a href="#add_eckey"><strong>add_eckey:</strong></a></li>
<li><a href="#start_key"><strong>start_key:</strong></a></li>
<li><a href="#find_eckey"><strong>find_eckey:</strong></a></li>
<li><a href="#remove_eckey"><strong>remove_eckey:</strong></a></li>
<li><a href="#dogecoin_key_free"><strong>dogecoin_key_free:</strong></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="abstract"><a class="header" href="#abstract">Abstract</a></h2>
<p>This document explains the basic elliptic curve key API within libdogecoin.</p>
<h2 id="specification"><a class="header" href="#specification">Specification</a></h2>
<p>Cited from <a href="https://en.bitcoin.it/wiki/Elliptic_Curve_Digital_Signature_Algorithm">https://en.bitcoin.it/wiki/Elliptic_Curve_Digital_Signature_Algorithm</a></p>
<h3 id="background-on-ecdsa-signatures"><a class="header" href="#background-on-ecdsa-signatures">Background on ECDSA Signatures</a></h3>
<p>Elliptic Curve Digital Signature Algorithm or ECDSA is a cryptographic algorithm used by Dogecoin to ensure that funds can only be spent by their rightful owners. It is dependent on the curve order and hash function used. For dogecoin these are Secp256k1 and SHA256(SHA256()) respectively.</p>
<p>A few concepts related to ECDSA:</p>
<ul>
<li><code>private key</code>: A secret number, known only to the person that generated it. A private key is essentially a randomly generated number. In Dogecoin, someone with the private key that corresponds to funds on the blockchain can spend the funds. In Dogecoin, a private key is a single unsigned 256 bit integer (32 bytes).</li>
<li><code>public key</code>: A number that corresponds to a private key, but does not need to be kept secret. A public key can be calculated from a private key, but not vice versa. A public key can be used to determine if a signature is genuine (in other words, produced with the proper key) without requiring the private key to be divulged. In Dogecoin, public keys are either compressed or uncompressed. Compressed public keys are 33 bytes, consisting of a prefix either 0x02 or 0x03, and a 256-bit integer called x. The older uncompressed keys are 65 bytes, consisting of constant prefix (0x04), followed by two 256-bit integers called x and y (2 * 32 bytes). The prefix of a compressed key allows for the y value to be derived from the x value.</li>
<li><code>signature</code>: A number that proves that a signing operation took place. A signature is mathematically generated from a hash of something to be signed, plus a private key. The signature itself is two numbers known as r and s. With the public key, a mathematical algorithm can be used on the signature to determine that it was originally produced from the hash and the private key, without needing to know the private key. Resulting signatures are either 73, 72, or 71 bytes long (with approximate probabilities of 25%, 50%, and 25%, respectively--although sizes even smaller than that are possible with exponentially decreasing probability).</li>
</ul>
<h3 id="primitives"><a class="header" href="#primitives">Primitives</a></h3>
<p>The ECDSA signing and verification algorithms make use of a few fundamental variables which are used to obtain a signature and the reverse process of getting a message from a signature.</p>
<ul>
<li><code>r</code> and <code>s</code>: These numbers uniquely represent the signature.</li>
<li><code>z</code>: The hash of the message we want to sign. Normally we are required to use the left-most N bits of the message hash, where <code>N</code> is the length of the hash function used, however, this rule does not apply to dogecoin signatures because the length of the hash function used, SHA256, equals the bit length of the secp256k1 curve (256) so no truncation is necessary.</li>
<li><code>k</code>: A cryptographicly secure random number which is used as a nonce to calculate the <code>r</code> and <code>s</code> values.</li>
<li><code>dA</code> and <code>QA</code>: These are the private key number and public key point respectively, used to sign and verify the message. Wallets can derive a copy of these when give an address contained inside the wallet.</li>
</ul>
<h3 id="verification-algorithm"><a class="header" href="#verification-algorithm">Verification Algorithm</a></h3>
<p>The verification algorithm ensures that the signature pair <code>r</code> and <code>s</code>, <code>QA</code> and <code>z</code> are all consistent.</p>
<ul>
<li>Verify that both <code>r</code> and <code>s</code> are between <code>1</code> and <code>n-1</code>.</li>
<li>Compute <code>u1 = z*s-1 mod n</code> and <code>u2 = r*s-1 mod n</code>.</li>
<li>Compute <code>(x, y) = u1*G + u2*QA</code> and ensure it is not equal to the point at infinity. The point at infinity is a special point that results when you add two points whose result would otherwise not lie on the curve, such as two points with the same <code>X</code> value but inverted <code>Y</code> values.</li>
<li>If <code>r = x mod n</code> then the signature is valid. Otherwise, or if any of the checks fail, then the signature is invalid.</li>
</ul>
<h2 id="basic-elliptic-curve-key-api"><a class="header" href="#basic-elliptic-curve-key-api">Basic Elliptic Curve Key API</a></h2>
<hr />
<h3 id="eckey"><a class="header" href="#eckey"><strong>eckey:</strong></a></h3>
<pre><code>typedef struct eckey {
    int idx;
    dogecoin_key private_key;
    char private_key_wif[PRIVKEYWIFLEN];
    dogecoin_pubkey public_key;
    char public_key_hex[PUBKEYHEXLEN];
    char address[P2PKHLEN];
    UT_hash_handle hh;
} eckey;
</code></pre>
<hr />
<h3 id="keys"><a class="header" href="#keys"><strong>keys:</strong></a></h3>
<pre><code>static eckey *keys = NULL;
</code></pre>
<p>This is an empty collection of key structures and meant for internal consumption.</p>
<hr />
<h3 id="new_eckey"><a class="header" href="#new_eckey"><strong>new_eckey:</strong></a></h3>
<pre><code class="language-c">eckey* new_eckey(dogecoin_bool is_testnet) {
    eckey* key = (struct eckey*)dogecoin_calloc(1, sizeof *key);
    dogecoin_privkey_init(&amp;key-&gt;private_key);
    assert(dogecoin_privkey_is_valid(&amp;key-&gt;private_key) == 0);
    dogecoin_privkey_gen(&amp;key-&gt;private_key);
    assert(dogecoin_privkey_is_valid(&amp;key-&gt;private_key)==1);
    dogecoin_pubkey_init(&amp;key-&gt;public_key);
    dogecoin_pubkey_from_key(&amp;key-&gt;private_key, &amp;key-&gt;public_key);
    assert(dogecoin_pubkey_is_valid(&amp;key-&gt;public_key) == 1);
    strcpy(key-&gt;public_key_hex, utils_uint8_to_hex((const uint8_t *)&amp;key-&gt;public_key, 33));
    uint8_t pkeybase58c[34];
    const dogecoin_chainparams* chain = is_testnet ? &amp;dogecoin_chainparams_test : &amp;dogecoin_chainparams_main;
    pkeybase58c[0] = chain-&gt;b58prefix_secret_address;
    pkeybase58c[33] = 1; /* always use compressed keys */
    memcpy_safe(&amp;pkeybase58c[1], &amp;key-&gt;private_key, DOGECOIN_ECKEY_PKEY_LENGTH);
    assert(dogecoin_base58_encode_check(pkeybase58c, sizeof(pkeybase58c), key-&gt;private_key_wif, sizeof(key-&gt;private_key_wif)) != 0);
    if (!dogecoin_pubkey_getaddr_p2pkh(&amp;key-&gt;public_key, chain, (char*)&amp;key-&gt;address)) return false;
    key-&gt;idx = HASH_COUNT(keys) + 1;
    return key;
}
</code></pre>
<p>This function instantiates a new working key, but does not add it to the hash table.</p>
<p><em>C usage:</em></p>
<pre><code class="language-c">eckey* key = new_eckey(false);
</code></pre>
<hr />
<h3 id="new_eckey_from_privkey"><a class="header" href="#new_eckey_from_privkey"><strong>new_eckey_from_privkey:</strong></a></h3>
<pre><code class="language-c">eckey* new_eckey_from_privkey(char* private_key) {
    eckey* key = (struct eckey*)dogecoin_calloc(1, sizeof *key);
    dogecoin_privkey_init(&amp;key-&gt;private_key);
    const dogecoin_chainparams* chain = chain_from_b58_prefix(private_key);
    if (!dogecoin_privkey_decode_wif(private_key, chain, &amp;key-&gt;private_key)) return false;
    assert(dogecoin_privkey_is_valid(&amp;key-&gt;private_key)==1);
    dogecoin_pubkey_init(&amp;key-&gt;public_key);
    dogecoin_pubkey_from_key(&amp;key-&gt;private_key, &amp;key-&gt;public_key);
    assert(dogecoin_pubkey_is_valid(&amp;key-&gt;public_key) == 1);
    strcpy(key-&gt;public_key_hex, utils_uint8_to_hex((const uint8_t *)&amp;key-&gt;public_key, 33));
    uint8_t pkeybase58c[34];
    pkeybase58c[0] = chain-&gt;b58prefix_secret_address;
    pkeybase58c[33] = 1; /* always use compressed keys */
    memcpy_safe(&amp;pkeybase58c[1], &amp;key-&gt;private_key, DOGECOIN_ECKEY_PKEY_LENGTH);
    assert(dogecoin_base58_encode_check(pkeybase58c, sizeof(pkeybase58c), key-&gt;private_key_wif, sizeof(key-&gt;private_key_wif)) != 0);
    if (!dogecoin_pubkey_getaddr_p2pkh(&amp;key-&gt;public_key, chain, (char*)&amp;key-&gt;address)) return false;
    key-&gt;idx = HASH_COUNT(keys) + 1;
    return key;
}
</code></pre>
<p>This function instantiates a new working key from a <code>private_key</code> in WIF format, but does not add it to the hash table.</p>
<p><em>C usage:</em></p>
<pre><code class="language-c">char* privkey = "QUtnMFjt3JFk1NfeMe6Dj5u4p25DHZA54FsvEFAiQxcNP4bZkPu2";
eckey* key = new_eckey_from_privkey(privkey);
...

dogecoin_free(key);
</code></pre>
<hr />
<h3 id="add_eckey"><a class="header" href="#add_eckey"><strong>add_eckey:</strong></a></h3>
<pre><code class="language-c">void add_eckey(eckey *key) {
    eckey* key_old;
    HASH_FIND_INT(keys, &amp;key-&gt;idx, key_old);
    if (key_old == NULL) {
        HASH_ADD_INT(keys, idx, key);
    } else {
        HASH_REPLACE_INT(keys, idx, key, key_old);
    }
    dogecoin_free(key_old);
}
</code></pre>
<p>This function takes a pointer to an existing working eckey object and adds it to the hash table.</p>
<p><em>C usage:</em></p>
<pre><code class="language-c">eckey* key = new_eckey(false);
add_eckey(key);
</code></pre>
<hr />
<h3 id="start_key"><a class="header" href="#start_key"><strong>start_key:</strong></a></h3>
<pre><code class="language-c">int start_key(dogecoin_bool is_testnet) {
    eckey* key = new_eckey(is_testnet);
    int index = key-&gt;idx;
    add_eckey(key);
    return index;
}
</code></pre>
<p>This function creates a new eckey, places it in the hash table, and returns the index of the new eckey, starting from 1 and incrementing each subsequent call.</p>
<p><em>C usage:</em></p>
<pre><code class="language-c">int key_id = start_key(false);
</code></pre>
<hr />
<h3 id="find_eckey"><a class="header" href="#find_eckey"><strong>find_eckey:</strong></a></h3>
<pre><code class="language-c">eckey* find_eckey(int idx) {
    eckey* key;
    HASH_FIND_INT(keys, &amp;idx, key);
    return key;
}
</code></pre>
<p>This function takes an index and returns the working eckey associated with that index in the hash table.</p>
<p><em>C usage:</em></p>
<pre><code class="language-c">...
int key_id = start_key(false);
eckey* key = find_eckey(key_id);
...
</code></pre>
<hr />
<h3 id="remove_eckey"><a class="header" href="#remove_eckey"><strong>remove_eckey:</strong></a></h3>
<pre><code class="language-c">void remove_eckey(eckey* key) {
    HASH_DEL(keys, key); /* delete it (keys advances to next) */
    dogecoin_privkey_cleanse(&amp;key-&gt;private_key);
    dogecoin_pubkey_cleanse(&amp;key-&gt;public_key);
    dogecoin_key_free(key);
}
</code></pre>
<p>This function removes the specified working eckey from the hash table and frees the eckey in memory.</p>
<p><em>C usage:</em></p>
<pre><code class="language-c">int key_id = start_key(false);
eckey* key = find_eckey(key_id);
remove_eckey(key)
</code></pre>
<hr />
<h3 id="dogecoin_key_free"><a class="header" href="#dogecoin_key_free"><strong>dogecoin_key_free:</strong></a></h3>
<pre><code class="language-c">void dogecoin_key_free(eckey* eckey)
{
    dogecoin_free(eckey);
}
</code></pre>
<p>This function frees the memory allocated for an eckey.</p>
<p><em>C usage:</em></p>
<pre><code class="language-c">...
dogecoin_key_free(key);
...
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="address.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="enclaves.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="address.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="enclaves.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="ace.js"></script>
        <script src="mode-rust.js"></script>
        <script src="editor.js"></script>
        <script src="theme-dawn.js"></script>
        <script src="theme-tomorrow_night.js"></script>

        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
